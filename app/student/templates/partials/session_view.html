<div class="max-w-3xl mx-auto p-4">
  <!-- Back button -->
  {# <button 
      hx-get="{{ url_for('student.learning_room', course_id=session.chapter.course_id) }}"
      hx-target="#content-wrapper"
      hx-swap="innerHTML"
      class="inline-flex items-center px-4 py-2 mb-4 text-sm font-medium text-indigo-600 
             bg-indigo-50 rounded-lg border border-indigo-200 shadow-sm 
             hover:bg-indigo-100 hover:text-indigo-800 transition duration-200"
  >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Chapter List
  </button> #}

  <h2 class="text-xl font-bold mb-4">{{ session.title }}</h2>

  <!-- ---------------- LEARNING SESSION ---------------- -->
  {% if session.session_type == "learning_session" %}
  <div class="space-y-4">
    {% for m in materials %}
      <div class="p-4 border rounded-lg bg-white shadow-sm">
        <h3 class="font-semibold">{{ m.name }}</h3>

        {% if m.type == "text" %}
          <p class="text-gray-700 mt-2">{{ m.content }}</p>

        {% elif m.type == "video" %}
          {% if "youtube.com/watch?v=" in m.content %}
            {% set video_id = m.content.split('v=')[-1].split('&')[0] %}
            <iframe src="https://www.youtube.com/embed/{{ video_id }}" class="w-full aspect-video mt-2 rounded" allowfullscreen></iframe>
          {% elif "youtu.be/" in m.content %}
            {% set video_id = m.content.split('/')[-1] %}
            <iframe src="https://www.youtube.com/embed/{{ video_id }}" class="w-full aspect-video mt-2 rounded" allowfullscreen></iframe>
          {% else %}
            <iframe src="{{ m.content }}" class="w-full aspect-video mt-2 rounded" allowfullscreen></iframe>
          {% endif %}

        {% elif m.type == "image" %}
          <img src="{{ m.content }}" alt="{{ m.name }}" class="mt-2 rounded-lg max-h-64 mx-auto">
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Always show continue for learning sessions -->
  <!-- Always show continue for learning sessions -->
{% if next_session %}
  <div class="mt-6 text-right">
    <button 
        hx-get="{{ url_for('student.session_view', session_id=next_session.id, enrollment_id=enrollment_id) }}"
        hx-target="#content-wrapper"
        hx-swap="innerHTML"
        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
    >
        Continue →
    </button>
  </div>
  {% else %}
  <button 
      hx-get="{{ url_for('student.learning_room', course_id=session.chapter.course_id) }}"
      hx-target="#content-wrapper"
      hx-swap="innerHTML"
      class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
  > Finish 
</button>
{% endif %}

  {% endif %}

  <!-- ---------------- QUIZ SESSION ---------------- -->
 {% if session.session_type == "quiz_session" %}
  <div class="space-y-6">
    {% for quiz in quizzes %}
      <div class="p-4 border rounded-lg bg-white shadow-sm" id="quiz-{{ quiz.id }}">
        <h3 class="font-semibold text-lg">{{ quiz.name }}</h3>

        {% for qid, question in quiz.question.items() %}
          <div class="mt-4 question-block" sdata-qid="{{ qid }}">
            <p class="font-medium">{{ qid }}. {{ question }}</p>

            {% if quiz.type in ["MCQ", "TF"] %}
              {% set opts = quiz.option[qid] %}
              <div class="mt-2 space-y-2">
                {% for opt in opts %}
                  <label class="flex items-center space-x-2">
                    <input 
                      type="radio" 
                      name="q{{ quiz.id }}_{{ qid }}" 
                      value="{{ opt }}" 
                      class="quiz-input text-indigo-600 focus:ring-indigo-500"
                      data-correct="{{ quiz.key[qid] }}"
                    >
                    <span>{{ opt }}</span>
                  </label>
                {% endfor %}
              </div>

            {% elif quiz.type == "Blank" %}
              <div class="mt-2">
                <input 
                  type="text" 
                  name="q{{ quiz.id }}_{{ qid }}" 
                  placeholder="Type your answer..." 
                  class="quiz-input w-full border rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
                  data-correct="{{ quiz.key[qid] }}"
                >
              </div>
            {% endif %}

            <!-- Correct answer placeholder -->
            <p class="correct-answer text-green-600 text-sm mt-2 hidden"></p>
          </div>
        {% endfor %}

        <div class="mt-4">
          <button 
            type="button"
            class="check-btn px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition"
            data-quiz-id="{{ quiz.id }}"
          >
            Check
          </button>
          <p class="text-red-500 text-sm mt-2 hidden" id="warning-{{ quiz.id }}">
            Please answer all questions before continuing.
          </p>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if next_session is not none %}
  <div class="mt-6 text-right hidden" id="continue-btn-wrapper">
    <button 
        hx-get="{{ url_for('student.session_view', session_id=next_session.id, enrollment_id=enrollment_id) }}"
        hx-target="#content-wrapper"
        hx-swap="innerHTML"
        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
    >
        Continue →
    </button>
  </div>
  {% elif next_session is none %}
  <!-- Finish Button -->
  <div class="mt-6 text-right" id="continue-btn-wrapper">
    <button 
        id = "continue-btn-wrapper"
        hx-get="{{ url_for('student.learning_room', course_id=session.chapter.course_id) }}"
        hx-target="#content-wrapper"
        hx-swap="innerHTML" 
        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
    >
        Finish
    </button>
  </div>

{% endif %}
<script>
// Only declare if not already defined
if (typeof ENROLLMENT_ID === 'undefined') {
    var ENROLLMENT_ID = {{ enrollment_id|tojson }};
}

document.querySelectorAll(".check-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const quizId = this.dataset.quizId;
    const quizBlock = document.getElementById(`quiz-${quizId}`);
    const inputs = quizBlock.querySelectorAll(".quiz-input");
    let allFilled = true;

    // Group inputs by question
    const grouped = {};
    inputs.forEach(input => {
      const name = input.name;
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(input);
    });

    // Validate each group
    for (const [name, group] of Object.entries(grouped)) {
      if (group[0].type === "radio") {
        if (![...group].some(r => r.checked)) allFilled = false;
      } else if (group[0].type === "text") {
        if (group[0].value.trim() === "") allFilled = false;
      }
    }

    const warning = document.getElementById(`warning-${quizId}`);
    if (!allFilled) {
      warning.classList.remove("hidden");
      return; // stop here if not filled
    } else {
      warning.classList.add("hidden");
    }

    // ✅ Collect answers
    const answers = {};
    for (const [name, group] of Object.entries(grouped)) {
      if (group[0].type === "radio") {
        const selected = [...group].find(r => r.checked);
        answers[name] = selected ? selected.value : null;
      } else if (group[0].type === "text") {
        answers[name] = group[0].value.trim();
      }
    }

    // ✅ Show correct answers
    quizBlock.querySelectorAll(".question-block").forEach(block => {
      // Find any input inside this question block that has data-correct
      const correctInput = block.querySelector("[data-correct]");
      if (!correctInput) return;
      const correctKey = correctInput.dataset.correct;
      const answerEl = block.querySelector(".correct-answer");
      if (answerEl) {
        answerEl.textContent = "Correct Answer: " + correctKey;
        answerEl.classList.remove("hidden");
      }
    });

    // ✅ Unlock continue button
    const continueBtnWrapper = document.getElementById("continue-btn-wrapper");
if (continueBtnWrapper) {
    continueBtnWrapper.classList.remove("hidden");
}

    // ✅ Send answers to backend
    fetch(`/student/submit_quiz/${quizId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ enrollment_id: ENROLLMENT_ID, answers: answers })
    })
    .then(res => res.json())
    .then(data => console.log("Server response:", data));

    // ✅ Disable this check button
    this.disabled = true;
    this.classList.add("opacity-50", "cursor-not-allowed");
  });
});
</script>

